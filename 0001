import streamlit as st
import pandas as pd
import sqlite3
import os
import hashlib
import base64
import uuid
from datetime import datetime

# --- CONFIGURA√á√ïES DE DIRET√ìRIO ---
DB_PATH = "condominio_v10.db"
UPLOAD_DIR = "evidencias"
if not os.path.exists(UPLOAD_DIR):
    os.makedirs(UPLOAD_DIR)

# --- FUN√á√ïES DE SEGURAN√áA E C√ÅLCULO ---
def hash_password(plain: str) -> str:
    salt = b'salt_condo_pro_2026_final' 
    dk = hashlib.pbkdf2_hmac("sha256", plain.encode("utf-8"), salt, 100_000)
    return base64.b64encode(dk).decode()

def verify_password(plain: str, stored: str) -> bool:
    return hash_password(plain) == stored

def calcular_tempo_finalizacao(data_inicio_str, data_fim_str):
    try:
        fmt = "%d/%m/%Y %H:%M"
        inicio = datetime.strptime(data_inicio_str, fmt)
        fim = datetime.strptime(data_fim_str, fmt)
        diferenca = fim - inicio
        dias, segundos = diferenca.days, diferenca.seconds
        horas = segundos // 3600
        minutos = (segundos // 60) % 60
        res = []
        if dias > 0: res.append(f"{dias}d")
        if horas > 0: res.append(f"{horas}h")
        if minutos > 0 or not res: res.append(f"{minutos}min")
        return " ".join(res)
    except: return "N/A"

# --- BANCO DE DADOS ---
def get_conn():
    return sqlite3.connect(DB_PATH, check_same_thread=False)

def init_db():
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("CREATE TABLE IF NOT EXISTS usuarios (username TEXT PRIMARY KEY, password_hash TEXT NOT NULL, role TEXT NOT NULL)")
    cur.execute("""CREATE TABLE IF NOT EXISTS ocorrencias (
                    id TEXT PRIMARY KEY, tipo_registro TEXT, categoria TEXT NOT NULL, 
                    local_detalhado TEXT, descricao TEXT NOT NULL, foto_path TEXT, 
                    status TEXT DEFAULT 'Pendente', data_envio TEXT, data_conclusao TEXT)""")
    if not cur.execute("SELECT * FROM usuarios WHERE username = 'admin'").fetchone():
        cur.execute("INSERT INTO usuarios VALUES (?, ?, ?)", ("admin", hash_password("admin123"), "admin"))
    conn.commit()
    conn.close()

init_db()

# --- INTERFACE ---
st.set_page_config(page_title="Condom√≠nio Pro", layout="centered", page_icon="üè¢")

# CSS para Cores de Status e Estilo Mobile
st.markdown("""
    <style>
    .status-pendente { color: #FFD700; font-weight: bold; }
    .status-manutencao { color: #FF4B4B; font-weight: bold; }
    .status-finalizado { color: #28A745; font-weight: bold; }
    .stButton>button { width: 100%; border-radius: 12px; height: 3em; font-weight: bold; }
    [data-testid="stExpander"] { border-radius: 10px; border: 1px solid #eee; }
    </style>
    """, unsafe_allow_html=True)

if "auth_adm" not in st.session_state:
    st.session_state.auth_adm = False

st.sidebar.title("üè¢ Gest√£o Pro")
menu = st.sidebar.radio("Navega√ß√£o", ["üìù Abrir Registro", "üîç Consultar Protocolo", "üìä Painel Administrativo"])

# --- 1. ABRIR REGISTRO ---
if menu == "üìù Abrir Registro":
    st.header("Novo Registro")
    with st.container(border=True):
        tipo_reg = st.radio("O que deseja realizar?", ["Abertura de Chamado", "Den√∫ncia"], horizontal=True)
        if tipo_reg == "Den√∫ncia":
            st.info("üîí **Sua den√∫ncia √© 100% an√¥nima.** O s√≠ndico ver√° apenas o local e o relato.")
        
        cat_sel = st.selectbox("√Årea:", ["Corredor", "Garagem", "Jardim", "Academia", "Elevador", "Piscina", "Outros"])
        detalhe = st.text_input("Localiza√ß√£o espec√≠fica (ex: Bloco B, Vaga 12):")
        desc = st.text_area("Relato da Ocorr√™ncia:", placeholder="Descreva os detalhes aqui...")
        foto = st.file_uploader("üì∏ Anexar Foto (Opcional)", type=["jpg", "png", "jpeg"])
        
        if st.button("ENVIAR REGISTRO", type="primary"):
            if desc:
                prot = str(uuid.uuid4())[:8].upper()
                path = None
                if foto:
                    path = os.path.join(UPLOAD_DIR, f"{prot}_{foto.name}")
                    with open(path, "wb") as f: f.write(foto.getbuffer())
                
                with get_conn() as conn:
                    conn.execute("INSERT INTO ocorrencias (id, tipo_registro, categoria, local_detalhado, descricao, foto_path, data_envio) VALUES (?,?,?,?,?,?,?)",
                                (prot, tipo_reg, cat_sel, detalhe, desc, path, datetime.now().strftime("%d/%m/%Y %H:%M")))
                st.success(f"‚úÖ Enviado com sucesso! Protocolo: **{prot}**")
            else: st.error("Por favor, preencha o relato da ocorr√™ncia.")

# --- 2. CONSULTAR PROTOCOLO ---
elif menu == "üîç Consultar Protocolo":
    st.header("Acompanhar Status")
    busca = st.text_input("Digite o seu Protocolo:").upper().strip()
    if busca:
        with get_conn() as conn:
            res = conn.execute("SELECT * FROM ocorrencias WHERE id = ?", (busca,)).fetchone()
        if res:
            with st.container(border=True):
                status = res[6]
                if status == "Pendente": st.warning(f"Status Atual: {status} üü°")
                elif status == "Em Manuten√ß√£o": st.error(f"Status Atual: {status} üî¥")
                else: st.success(f"Status Atual: {status} üü¢")
                
                st.write(f"**Relato:** {res[4]}")
                st.caption(f"Aberto em: {res[7]}")
                if res[8]:
                    tempo = calcular_tempo_finalizacao(res[7], res[8])
                    st.write(f"‚è±Ô∏è **Tempo total de resolu√ß√£o:** {tempo}")
                if res[5]: st.image(res[5])
        else: st.error("Protocolo n√£o localizado.")

# --- 3. PAINEL ADM ---
elif menu == "üìä Painel Administrativo":
    if not st.session_state.auth_adm:
        st.header("Acesso Restrito")
        u = st.text_input("Usu√°rio")
        p = st.text_input("Senha", type="password")
        if st.button("Entrar"):
            with get_conn() as conn:
                db_res = conn.execute("SELECT password_hash FROM usuarios WHERE username = ?", (u,)).fetchone()
            if db_res and verify_password(p, db_res[0]):
                st.session_state.auth_adm = True
                st.rerun()
            else: st.error("Acesso negado.")
    else:
        st.header("Painel Administrativo")
        tab1, tab2, tab3 = st.tabs(["‚ö° Atendimentos", "üìã Relat√≥rios", "üë§ Novo ADM"])
        
        with tab1:
            df = pd.read_sql("SELECT * FROM ocorrencias WHERE status != 'Finalizado' ORDER BY data_envio DESC", get_conn())
            if df.empty: st.info("N√£o h√° chamados pendentes.")
            for _, row in df.iterrows():
                cor_emoji = "üü°" if row['status'] == "Pendente" else "üî¥"
                with st.expander(f"{cor_emoji} {row['id']} - {row['tipo_registro']}"):
                    if row['status'] == "Pendente":
                        st.markdown('<p class="status-pendente">Aguardando In√≠cio (Pendente)</p>', unsafe_allow_html=True)
                    else:
                        st.markdown('<p class="status-manutencao">Em Execu√ß√£o (Manuten√ß√£o)</p>', unsafe_allow_html=True)
                    
                    st.write(f"**Local:** {row['categoria']} ({row['local_detalhado']})")
                    st.write(f"**Relato:** {row['descricao']}")
                    if row['foto_path']: st.image(row['foto_path'])
                    
                    # CORRE√á√ÉO AQUI: De ConUG para Finalizado
                    novo_st = st.selectbox("Status Mudar:", ["Pendente", "Em Manuten√ß√£o", "Finalizado"], 
                                         index=["Pendente", "Em Manuten√ß√£o", "Finalizado"].index(row['status']),
                                         key=f"adm_{row['id']}")
                    
                    if st.button("Salvar Altera√ß√£o", key=f"btn_{row['id']}"):
                        data_fim = datetime.now().strftime("%d/%m/%Y %H:%M") if novo_st == "Finalizado" else None
                        with get_conn() as conn:
                            conn.execute("UPDATE ocorrencias SET status = ?, data_conclusao = ? WHERE id = ?", (novo_st, data_fim, row['id']))
                        st.rerun()

        with tab2:
            st.subheader("Efici√™ncia de Resolu√ß√£o üü¢")
            df_concluidos = pd.read_sql("SELECT * FROM ocorrencias WHERE status = 'Finalizado' ORDER BY data_conclusao DESC", get_conn())
            if not df_concluidos.empty:
                df_concluidos['Tempo Total'] = df_concluidos.apply(lambda r: calcular_tempo_finalizacao(r['data_envio'], r['data_conclusao']), axis=1)
                st.dataframe(df_concluidos[['id', 'tipo_registro', 'data_envio', 'data_conclusao', 'Tempo Total']], use_container_width=True, hide_index=True)
            else: st.info("Ainda n√£o h√° chamados finalizados.")

        with tab3:
            st.subheader("Cadastrar Novo ADM")
            nu = st.text_input("Login")
            np = st.text_input("Senha", type="password")
            if st.button("Criar Acesso"):
                if nu and np:
                    try:
                        with get_conn() as conn:
                            conn.execute("INSERT INTO usuarios VALUES (?, ?, ?)", (nu, hash_password(np), "admin"))
                        st.success("Administrador cadastrado!")
                    except: st.error("Erro: Usu√°rio j√° existe.")

        if st.sidebar.button("Sair do Painel"):
            st.session_state.auth_adm = False
            st.rerun()
            
